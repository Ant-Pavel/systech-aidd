# Функциональные требования к дашборду статистики

## Обзор

Дашборд предоставляет визуальное представление статистики по диалогам Telegram-бота с пользователями. Интерфейс позволяет отслеживать ключевые метрики и анализировать активность пользователей за различные периоды времени.

## Целевая аудитория

- Администраторы системы
- Аналитики продукта
- Менеджеры проекта

## Функциональные требования

### 1. Карточки метрик

Дашборд должен отображать 3 основные метрики в виде карточек:

#### 1.1. Общее количество сообщений (Total Messages)

**Описание:** Общее количество всех сообщений (от пользователей и от бота) за выбранный период.

**Отображение:**
- Числовое значение (целое число)
- Процентное изменение относительно предыдущего периода
- Индикатор тренда (стрелка вверх/вниз)
- Краткое текстовое описание тренда

**Расчет:**
```
total_messages = COUNT(messages WHERE created_at IN period AND deleted_at IS NULL)
change_percent = ((current_period - previous_period) / previous_period) * 100
```

#### 1.2. Активные диалоги (Active Conversations)

**Описание:** Количество уникальных диалогов (пар user_id + chat_id), в которых была хотя бы одна активность за период.

**Отображение:**
- Числовое значение (целое число)
- Процентное изменение относительно предыдущего периода
- Индикатор тренда (стрелка вверх/вниз)
- Краткое текстовое описание

**Расчет:**
```
active_conversations = COUNT(DISTINCT (user_id, chat_id) WHERE created_at IN period AND deleted_at IS NULL)
change_percent = ((current_period - previous_period) / previous_period) * 100
```

#### 1.3. Средняя длина диалога (Avg Conversation Length)

**Описание:** Среднее количество сообщений в одном диалоге за период.

**Отображение:**
- Числовое значение (дробное, 1 знак после запятой)
- Процентное изменение относительно предыдущего периода
- Индикатор тренда (стрелка вверх/вниз)
- Краткое текстовое описание

**Расчет:**
```
avg_conversation_length = total_messages / active_conversations
change_percent = ((current_period - previous_period) / previous_period) * 100
```

### 2. График временного ряда

**Описание:** Линейный график, отображающий количество сообщений по дням/неделям/месяцам в зависимости от выбранного периода.

**Требования:**
- Ось X: временная шкала (даты)
- Ось Y: количество сообщений
- Несколько линий для сравнения (опционально, в текущей версии - одна линия)
- Плавная интерполяция между точками
- Адаптивная шкала по оси Y

**Группировка данных по периодам:**
- **7 дней (7d)**: данные по дням, 7 точек на графике
- **30 дней (30d)**: данные по дням, 30 точек на графике
- **3 месяца (3m)**: данные по неделям, ~12-13 точек на графике

### 3. Фильтрация по периодам

**Описание:** Переключатель периодов для изменения временного диапазона отображаемых данных.

**Доступные периоды:**
- Last 7 days (7d) - последние 7 дней
- Last 30 days (30d) - последние 30 дней
- Last 3 months (3m) - последние 3 месяца

**Поведение:**
- При переключении периода обновляются все метрики и график
- Выбранный период визуально выделен
- По умолчанию выбран период "Last 7 days"

## API Контракт

### Endpoint

```
GET /api/stats?period={period}
```

### Query Parameters

| Параметр | Тип | Обязательный | Значения | По умолчанию | Описание |
|----------|-----|--------------|----------|--------------|----------|
| period | string | Нет | 7d, 30d, 3m | 7d | Период для статистики |

### Response Model

```json
{
  "metrics": {
    "total_messages": {
      "value": 12543,
      "change_percent": 12.5,
      "trend": "up",
      "description": "Trending up this month"
    },
    "active_conversations": {
      "value": 1234,
      "change_percent": -5.2,
      "trend": "down",
      "description": "Down 5% this period"
    },
    "avg_conversation_length": {
      "value": 8.7,
      "change_percent": 3.1,
      "trend": "up",
      "description": "Steady performance increase"
    }
  },
  "time_series": [
    {"date": "2025-06-01", "value": 450},
    {"date": "2025-06-02", "value": 520},
    {"date": "2025-06-03", "value": 485}
  ]
}
```

### Response Fields

#### MetricCard Object

| Поле | Тип | Описание |
|------|-----|----------|
| value | number | Значение метрики (целое или дробное) |
| change_percent | number | Процентное изменение (-100 до +∞) |
| trend | string | Направление тренда: "up", "down", "stable" |
| description | string | Текстовое описание тренда |

#### TimeSeriesPoint Object

| Поле | Тип | Описание |
|------|-----|----------|
| date | string | Дата в формате ISO 8601 (YYYY-MM-DD) |
| value | number | Количество сообщений на эту дату |

### HTTP Status Codes

- `200 OK` - успешный запрос
- `400 Bad Request` - невалидный параметр period
- `500 Internal Server Error` - ошибка сервера

## Нефункциональные требования

### Производительность

- Время ответа API: < 500ms
- Время загрузки дашборда: < 2s

### Доступность

- Дашборд должен быть доступен 24/7
- Graceful degradation при недоступности API

### Безопасность

- API защищен от CORS атак (настроены правильные заголовки)
- В будущем: аутентификация и авторизация

## Будущие улучшения (не в текущем спринте)

- Фильтрация по пользователям
- Экспорт данных в CSV/Excel
- Сравнение периодов side-by-side
- Real-time обновление данных
- Детализация по времени суток
- Анализ sentiment сообщений
- Метрики производительности LLM

