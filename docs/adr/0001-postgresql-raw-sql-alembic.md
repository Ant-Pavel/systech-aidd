# ADR 0001: PostgreSQL + Raw SQL + Alembic для персистентного хранения

**Статус:** Принято  
**Дата:** 2025-10-16  
**Контекст:** Спринт S1 - Персистентное хранение данных

## Контекст и проблема

В MVP (S0) история диалогов хранится в оперативной памяти (in-memory). При перезапуске бота вся история теряется. Необходимо реализовать персистентное хранение истории диалогов, которое:

- Сохраняет данные между перезапусками
- Поддерживает асинхронные операции (aiogram async)
- Применяет soft delete стратегию
- Хранит метаданные сообщений (created_at, message_length)
- Соответствует принципу KISS

## Рассмотренные варианты

### 1. PostgreSQL + SQLAlchemy ORM

**Плюсы:**
- ORM упрощает работу с объектами
- Автоматическая генерация SQL
- Поддержка async через SQLAlchemy 2.0
- Популярное решение

**Минусы:**
- Оверинжиниринг для простых CRUD операций
- Дополнительный слой абстракции
- Сложнее отладка (нужно понимать как ORM генерирует SQL)
- Больше зависимостей

### 2. SQLite + aiosqlite

**Плюсы:**
- Не требует отдельного сервера
- Легкий вес
- Простота развертывания

**Минусы:**
- Ограничения при конкурентной записи
- Не подходит для production при масштабировании
- Менее мощные возможности индексации

### 3. PostgreSQL + Raw SQL + asyncpg (Выбрано)

**Плюсы:**
- ✅ Полный контроль над SQL запросами
- ✅ Прозрачность - видим что выполняется
- ✅ Максимальная производительность (asyncpg - самый быстрый драйвер)
- ✅ Production-ready БД
- ✅ Простота отладки
- ✅ Следует принципу KISS
- ✅ Async нативно
- ✅ Минимум зависимостей

**Минусы:**
- Нужно писать SQL вручную (но для наших простых запросов это не проблема)
- Требуется Docker для локальной разработки

## Решение

**Выбран вариант 3: PostgreSQL + Raw SQL + asyncpg + Alembic**

### Компоненты решения

#### PostgreSQL 16
- Production-ready СУБД
- Мощные возможности индексации
- Поддержка частичных индексов (для soft delete)
- Запуск через Docker Compose

#### asyncpg
- Асинхронный нативный драйвер PostgreSQL
- Самый быстрый Python драйвер для PostgreSQL
- Connection pooling из коробки
- Минимальные накладные расходы

#### Raw SQL
- Прямые SQL запросы без ORM
- Полная прозрачность
- Легко отлаживать и оптимизировать
- Соответствует принципу KISS

#### Alembic
- Индустриальный стандарт для миграций
- Async поддержка через SQLAlchemy engine
- Versioning и откаты миграций
- История изменений схемы БД

### Архитектура

```
DatabaseConversation (implements ConversationStorageProtocol)
    ↓
asyncpg connection pool
    ↓
PostgreSQL (Docker)
```

### Примеры SQL запросов

```sql
-- Добавление сообщения
INSERT INTO messages (user_id, chat_id, role, content, message_length)
VALUES ($1, $2, $3, $4, $5);

-- Получение истории (только не удаленные)
SELECT role, content, created_at, message_length
FROM messages
WHERE user_id = $1 AND chat_id = $2 AND deleted_at IS NULL
ORDER BY created_at DESC
LIMIT $3;

-- Soft delete
UPDATE messages
SET deleted_at = NOW()
WHERE user_id = $1 AND chat_id = $2 AND deleted_at IS NULL;
```

## Последствия

### Положительные

1. **Производительность** - asyncpg обеспечивает максимальную скорость
2. **Простота** - raw SQL легко понять и отладить
3. **Контроль** - полный контроль над запросами и индексами
4. **Масштабируемость** - PostgreSQL готов для production
5. **Гибкость** - легко оптимизировать запросы при необходимости

### Отрицательные

1. **Ручной SQL** - нужно писать запросы вручную (но они простые)
2. **Docker** - требуется Docker для локальной разработки
3. **Миграции** - нужно вручную писать SQL в миграциях Alembic

### Компромиссы

- Отказались от ORM в пользу простоты и производительности
- Выбрали PostgreSQL вместо SQLite для production-ready решения
- Используем SQLAlchemy только для Alembic async engine (не для ORM)

## Альтернативы в будущем

Если требования изменятся:
- При необходимости сложных запросов можно добавить SQLAlchemy ORM локально
- Для аналитики можно добавить read-only replica
- При очень высокой нагрузке можно добавить кеш (Redis)

## Ссылки

- [asyncpg documentation](https://magicstack.github.io/asyncpg/)
- [Alembic documentation](https://alembic.sqlalchemy.org/)
- [PostgreSQL documentation](https://www.postgresql.org/docs/)


